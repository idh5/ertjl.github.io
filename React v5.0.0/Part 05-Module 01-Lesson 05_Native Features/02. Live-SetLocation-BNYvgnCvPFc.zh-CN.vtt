WEBVTT
Kind: captions
Language: zh-CN

00:00:00.000 --> 00:00:03.549
现在到了比较有趣的部分了

00:00:03.549 --> 00:00:05.740
在本视频中 我们将向用户

00:00:05.740 --> 00:00:08.539
请求权限

00:00:08.539 --> 00:00:14.529
设置位置信息 然后显示实时数据 而不是这些虚拟数据

00:00:14.529 --> 00:00:16.524
首先

00:00:16.524 --> 00:00:19.674
我们需要导入一些内容

00:00:19.675 --> 00:00:24.024
导入 Location 和 Permission 都来自于 expo

00:00:24.024 --> 00:00:31.004
然后导入 calculateDirection 来自于 utils/helpers

00:00:31.004 --> 00:00:37.039
首先创建一个方法 叫做 setLocation

00:00:37.039 --> 00:00:40.960
当我们确认获得了位置信息访问权后

00:00:40.960 --> 00:00:45.554
就会调用该方法

00:00:45.554 --> 00:00:52.875
我们将调用 Location.watchPositionAsync

00:00:52.875 --> 00:00:57.480
传入几个不同的选项

00:00:57.479 --> 00:01:01.449
输入 enableHighAccuracy 设为 true

00:01:01.450 --> 00:01:05.740
因为我们很关心手机位置的细微变化

00:01:05.739 --> 00:01:08.674
timeInterval 设为 1

00:01:08.674 --> 00:01:12.310
distanceInterval 设为 1

00:01:12.310 --> 00:01:15.939
这么设置的原因是这是更新频率

00:01:15.939 --> 00:01:18.117
我不知道最低频率是多少

00:01:18.117 --> 00:01:20.766
所以直接输入 1 因为我希望更新这些信息

00:01:20.766 --> 00:01:24.005
希望能尽快更新用户的位置信息

00:01:24.004 --> 00:01:29.439
现在传入一个回调函数

00:01:29.439 --> 00:01:31.914
作为 watchPositionAsync 的第二个参数

00:01:31.915 --> 00:01:35.560
因为每当手机位置变化时

00:01:35.560 --> 00:01:38.275
就会调用该函数

00:01:38.275 --> 00:01:41.230
我们将传入手机的坐标

00:01:41.230 --> 00:01:45.395
在这里输入 newDirection = calculateDirection

00:01:45.394 --> 00:01:50.349
传入 coords.heading

00:01:50.349 --> 00:01:54.914
这个将传入东北方向等等

00:01:54.915 --> 00:01:59.969
我们还将从 this.state 获取 direction

00:01:59.969 --> 00:02:01.840
我们将在后面的视频中解释

00:02:01.840 --> 00:02:05.085
这么设置的原因

00:02:05.084 --> 00:02:06.879
暂时先这么设置

00:02:06.879 --> 00:02:09.810
现在输入 this.setState

00:02:09.810 --> 00:02:12.689
我们将在这里

00:02:12.689 --> 00:02:17.245
使用坐标更新状态

00:02:17.245 --> 00:02:24.515
status 为 granted direction 为 newDirection

00:02:24.514 --> 00:02:27.429
我们设置好了 setLocation

00:02:27.430 --> 00:02:30.923
但在此之前 我们需要转到 componentDidMount 中

00:02:30.923 --> 00:02:33.039
确保获得正确的权限

00:02:33.039 --> 00:02:37.034
或需要请求用户授予这些权限

00:02:37.034 --> 00:02:41.889
我们可以调用 permissions.getAsync,

00:02:41.889 --> 00:02:48.534
需要获得的权限是 permissions.LOCATION

00:02:48.534 --> 00:02:51.669
然后传入一个对象

00:02:51.669 --> 00:02:54.954
具有 status 属性

00:02:54.955 --> 00:02:58.825
正如之前看到的

00:02:58.824 --> 00:03:04.310
如果 status 是 granted 则调用 setLocation

00:03:04.310 --> 00:03:07.555
如果我们请求权限后 用户授予权限

00:03:07.555 --> 00:03:10.750
或已经被授予权限

00:03:10.750 --> 00:03:13.615
则设置位置信息

00:03:13.615 --> 00:03:20.650
如果不是这种情况 则调用 setStates 并更新 status

00:03:20.650 --> 00:03:23.730
如果出现任何问题

00:03:23.730 --> 00:03:27.074
则 catch 这一错误

00:03:27.074 --> 00:03:29.649
然后输入 console.warn

00:03:29.650 --> 00:03:34.645
“Error getting Location permission:” 显示该错误

00:03:34.645 --> 00:03:38.080
然后更新 setState

00:03:38.080 --> 00:03:43.130
输入 status: ‘undetermined’

00:03:43.129 --> 00:03:46.590
看看是否可行

00:03:46.590 --> 00:03:51.099
我在模拟器中重置下所有设置

00:03:51.099 --> 00:03:57.400
以便从头显示所发生的情况

00:03:57.400 --> 00:04:00.240
出现了很严重的错误提示：

00:04:00.240 --> 00:04:03.760
Can't find variable: Permissions because we called

00:04:03.759 --> 00:04:08.560
因为这里是 permission 而不是 of permissions 现在应该可行了

00:04:08.560 --> 00:04:10.469
Got it expo

00:04:10.469 --> 00:04:14.990
转到 Live 标签页 很扫兴

00:04:14.990 --> 00:04:16.730
系统提示

00:04:16.730 --> 00:04:19.340
我们需要启用位置服务

00:04:19.339 --> 00:04:22.664
出现这个屏幕是因为

00:04:22.665 --> 00:04:24.050
当组件加载时 我们会问

00:04:24.050 --> 00:04:25.525
我们有权限吗？

00:04:25.524 --> 00:04:29.179
获得这些位置服务的权限

00:04:29.180 --> 00:04:30.525
如果已经授予权限

00:04:30.524 --> 00:04:32.239
则设置位置信息

00:04:32.240 --> 00:04:33.514
如果没有授予

00:04:33.514 --> 00:04:36.509
则将 status 设为任意状态

00:04:36.509 --> 00:04:40.634
因此我们没有实际地请求权限

00:04:40.634 --> 00:04:42.829
这将是下个视频的任务

00:04:42.829 --> 00:04:46.669
也就是如何向用户请求权限

00:04:46.670 --> 00:04:48.259
这样的话 这里如果没有授予权限

00:04:48.259 --> 00:04:50.810
则可以请求权限

00:04:50.810 --> 00:04:54.000
此外 当用户点击这个按钮时 也可以请求权限

